import socket
import os

PORT = 7123        # Skal matche Photon-koden

def get_next_filename(base="Udryknings_kørsel", ext=".csv"):
    """Find næste ledige filnavn med løbenummer."""
    i = 0
    while True:
        filename = f"{base}{i:04d}{ext}"
        if not os.path.exists(filename):
            return filename
        i += 1

def run_server():
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as server:
        server.bind(("", PORT))
        server.listen(1)
        print(f"Server listening on {PORT}...")

        while True:
            conn, addr = server.accept()
            print(f"Connection from {addr}")
            filename = get_next_filename()
            with open(filename, "w") as f:
                f.write("timestamp,accX,accY,accZ\n")  # CSV header
                with conn:
                    while True:
                        data = conn.recv(1024)
                        if not data:
                            break
                        # data er bytes → dekode til tekst
                        text = data.decode("utf-8", errors="ignore")
                        f.write(text)
            print(f"Saved data to {filename}")

if __name__ == "__main__":
    run_server()